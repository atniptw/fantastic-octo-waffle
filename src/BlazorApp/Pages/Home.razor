@page "/"
@layout PlannerLayout
@inject DecorationIndexService DecorationIndex
@inject AssetStoreService AssetStore
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Outfit Planner</PageTitle>

<div class="planner-content">
	<section class="planner-home">
		<aside class="planner-panel planner-library">
			<div class="planner-panel__title">Parts / Mods</div>
			@if (VisibleEntries.Count == 0)
			{
				<div class="planner-empty">No mods loaded yet.</div>
			}
			else
			{
				<div class="planner-list" role="list">
					@foreach (var entry in VisibleEntries)
					{
						var isSelected = IsSelected(entry);
						<label class="planner-entry @(isSelected ? "planner-entry--selected" : string.Empty)">
							<input
								class="planner-entry__checkbox"
								type="checkbox"
								checked="@isSelected"
								@onchange="(args) => ToggleEntryAsync(entry, args)"
								data-testid="item-@entry.Sha256" />
							<span class="planner-entry__details">
								<span class="planner-entry__name">@DecorationNameFormatter.GetDisplayName(entry.FilePath)</span>
								<span class="planner-entry__meta">@entry.BodyPart • @FormatFileSize(entry.SizeBytes)</span>
							</span>
						</label>
					}
				</div>
			}
		</aside>

		<section class="planner-panel planner-preview">
			<div class="planner-panel__title">Preview</div>
			<div class="planner-viewport">
				<model-viewer
					id="planner-preview-viewer"
					class="planner-model-viewer"
					camera-controls
					auto-rotate
					touch-action="pan-y"
					data-testid="preview-viewer">
				</model-viewer>
				@if (!string.IsNullOrWhiteSpace(previewStatusMessage))
				{
					<div class="planner-preview__message" data-testid="preview-status">@previewStatusMessage</div>
				}
			</div>
		</section>
	</section>

	<footer class="planner-footer">
		<div class="planner-filters">
			<span class="planner-filters__label">Filters</span>
			@foreach (var filter in Filters)
			{
				var isActive = string.Equals(filter, activeFilter, StringComparison.OrdinalIgnoreCase);
				<button class="planner-filter @(isActive ? "planner-filter--active" : string.Empty)" type="button" @onclick="() => SetFilter(filter)">
					@filter
				</button>
			}
		</div>
		<div class="planner-footer__actions">
			<button class="btn btn-outline-secondary" type="button" @onclick="ClearSelectionsAsync" disabled="@(DecorationIndex.Entries.Count == 0 || selectedByBodyPart.Count == 0)">
				Clear All
			</button>
			<button class="btn btn-outline-danger" type="button" @onclick="ClearDatabaseAsync" disabled="@(isClearingDatabase || DecorationIndex.Entries.Count == 0)">
				@(isClearingDatabase ? "Clearing..." : "Clear DB")
			</button>
		</div>
	</footer>
</div>

<ModsWizard />

@code {
	private const string PreviewElementId = "planner-preview-viewer";
	private const string FilterAll = "ALL";
	private readonly Dictionary<string, string> selectedByBodyPart = new(StringComparer.OrdinalIgnoreCase);
	private IJSObjectReference? previewModule;
	private string? activeBodyPart;
	private string activeFilter = FilterAll;
	private bool isClearingDatabase;
	private string? previewStatusMessage;

	private IReadOnlyList<string> BodyPartGroups => DecorationIndex.Entries
		.Select(entry => entry.BodyPart)
		.Distinct(StringComparer.OrdinalIgnoreCase)
		.OrderBy(item => item, StringComparer.OrdinalIgnoreCase)
		.ToList();

	private IReadOnlyList<string> Filters => new[] { FilterAll }
		.Concat(BodyPartGroups)
		.ToList();

	private IReadOnlyList<DecorationEntry> VisibleEntries => DecorationIndex.Entries
		.Where(entry => string.Equals(activeFilter, FilterAll, StringComparison.OrdinalIgnoreCase)
			|| string.Equals(entry.BodyPart, activeFilter, StringComparison.OrdinalIgnoreCase))
		.OrderBy(entry => entry.BodyPart, StringComparer.OrdinalIgnoreCase)
		.ThenBy(entry => entry.FilePath, StringComparer.OrdinalIgnoreCase)
		.ToList();

	protected override void OnInitialized()
	{
		DecorationIndex.OnChange += HandleDecorationIndexChanged;
	}

	protected override async Task OnInitializedAsync()
	{
		await DecorationIndex.LoadPersistedAsync();
		RefreshSelectionAndStatusFromEntries();
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (!firstRender)
		{
			return;
		}

		previewModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/previewInterop.js");
		if (!string.IsNullOrWhiteSpace(activeBodyPart))
		{
			await SyncPreviewToCurrentSelectionAsync();
		}
	}

	private DecorationEntry? GetSelectedEntry(string bodyPart)
	{
		if (!selectedByBodyPart.TryGetValue(bodyPart, out var selectedId))
		{
			return null;
		}

		return DecorationIndex.Entries.FirstOrDefault(entry =>
			string.Equals(entry.BodyPart, bodyPart, StringComparison.OrdinalIgnoreCase)
			&& string.Equals(entry.Sha256, selectedId, StringComparison.OrdinalIgnoreCase));
	}

	private bool IsSelected(DecorationEntry entry)
		=> selectedByBodyPart.TryGetValue(entry.BodyPart, out var selectedId)
			&& string.Equals(selectedId, entry.Sha256, StringComparison.OrdinalIgnoreCase);

	private void SetFilter(string filter)
	{
		activeFilter = filter;
	}

	private async Task ToggleEntryAsync(DecorationEntry entry, ChangeEventArgs args)
	{
		var isChecked = args.Value is bool value && value;
		if (isChecked)
		{
			selectedByBodyPart[entry.BodyPart] = entry.Sha256;
			activeBodyPart = entry.BodyPart;
			await SyncPreviewToCurrentSelectionAsync();
			return;
		}

		if (IsSelected(entry))
		{
			selectedByBodyPart.Remove(entry.BodyPart);
			if (string.Equals(activeBodyPart, entry.BodyPart, StringComparison.OrdinalIgnoreCase))
			{
				activeBodyPart = null;
			}
		}

		await SyncPreviewToCurrentSelectionAsync();
	}

	private async Task SyncPreviewToCurrentSelectionAsync()
	{
		if (previewModule is null)
		{
			return;
		}

		if (string.IsNullOrWhiteSpace(activeBodyPart))
		{
			await previewModule.InvokeVoidAsync("clearPreview", PreviewElementId);
			previewStatusMessage = "Select an item to preview.";
			await InvokeAsync(StateHasChanged);
			return;
		}

		var selectedEntry = GetSelectedEntry(activeBodyPart);
		if (selectedEntry is null)
		{
			await previewModule.InvokeVoidAsync("clearPreview", PreviewElementId);
			previewStatusMessage = "Select an item to preview.";
			await InvokeAsync(StateHasChanged);
			return;
		}

		var previewResult = await previewModule.InvokeAsync<PreviewResult>("previewAsset", PreviewElementId, selectedEntry.Sha256);
		previewStatusMessage = previewResult.Success
			? $"Previewing {DecorationNameFormatter.GetDisplayName(selectedEntry.FilePath)}"
			: previewResult.Reason ?? "Preview unavailable for selected item.";
		await InvokeAsync(StateHasChanged);
	}

	private static string FormatFileSize(long bytes)
	{
		const decimal kilo = 1024m;
		const decimal mega = 1024m * 1024m;

		if (bytes >= mega)
		{
			return $"{bytes / mega:0.##} MB";
		}

		return $"{bytes / kilo:0.##} KB";
	}

	private async Task ClearSelectionsAsync()
	{
		selectedByBodyPart.Clear();
		activeBodyPart = null;
		previewStatusMessage = DecorationIndex.Entries.Count == 0
			? "Load mods to start previewing items."
			: "Select an item to preview.";
		if (previewModule is not null)
		{
			await previewModule.InvokeVoidAsync("clearPreview", PreviewElementId);
		}
	}

	private async Task ClearDatabaseAsync()
	{
		isClearingDatabase = true;
		await AssetStore.DeleteDatabaseAsync();
		await DecorationIndex.ReloadPersistedAsync();
		selectedByBodyPart.Clear();
		activeBodyPart = null;
		activeFilter = FilterAll;
		if (previewModule is not null)
		{
			await previewModule.InvokeVoidAsync("clearPreview", PreviewElementId);
		}
		previewStatusMessage = "Library cleared. Load mods to start previewing items.";
		isClearingDatabase = false;
	}

	private void RefreshSelectionAndStatusFromEntries()
	{
		if (BodyPartGroups.Count == 0)
		{
			activeBodyPart = null;
			activeFilter = FilterAll;
			previewStatusMessage = "Load mods to start previewing items.";
			return;
		}

		if (!string.IsNullOrWhiteSpace(activeBodyPart)
			&& !BodyPartGroups.Contains(activeBodyPart, StringComparer.OrdinalIgnoreCase))
		{
			activeBodyPart = null;
		}

		if (!string.Equals(activeFilter, FilterAll, StringComparison.OrdinalIgnoreCase)
			&& !BodyPartGroups.Contains(activeFilter, StringComparer.OrdinalIgnoreCase))
		{
			activeFilter = FilterAll;
		}

		previewStatusMessage = "Select an item to preview.";
	}

	private void HandleDecorationIndexChanged()
	{
		RefreshSelectionAndStatusFromEntries();
		_ = InvokeAsync(async () =>
		{
			await SyncPreviewToCurrentSelectionAsync();
			StateHasChanged();
		});
	}

	public async ValueTask DisposeAsync()
	{
		DecorationIndex.OnChange -= HandleDecorationIndexChanged;

		if (previewModule is null)
		{
			return;
		}

		await previewModule.InvokeVoidAsync("clearPreview", PreviewElementId);
		await previewModule.DisposeAsync();
	}

	private sealed class PreviewResult
	{
		public bool Success { get; set; }
		public string? Reason { get; set; }
	}
}
