@page "/"
@inject NavigationManager Navigation

<PageTitle>R.E.P.O Outfit Planner</PageTitle>

<section class="landing">
	<header class="landing__header">
		<h1>R.E.P.O Outfit Planner</h1>
		<p>Preview and plan cosmetic loadouts locally in your browser.</p>
	</header>

	<div class="landing__steps">
		<div class="step-card">
			<div class="step-card__title">Step 1: Upload Base Mod</div>
			<div class="dropzone">
				<div class="dropzone__hint">Drop MoreHead zip/dll here</div>
				<InputFile OnChange="HandleBaseModSelected" class="dropzone__input" data-testid="base-mod-input" />
				<div class="dropzone__status @(IsBaseModLoaded ? "success" : string.Empty)" data-testid="base-mod-status">
					@if (baseModFile is null)
					{
						<span>Status: No base mod selected</span>
					}
					else
					{
						<span>Status: Loaded @baseModFile.Name (@FormatFileSize(baseModFile.Size))</span>
					}
				</div>
			</div>
		</div>

		<div class="step-card">
			<div class="step-card__title">Step 2: Upload Cosmetic Mods</div>
			<div class="dropzone">
				<div class="dropzone__hint">Drop cosmetic mods here</div>
				<InputFile OnChange="HandleCosmeticModsSelected" class="dropzone__input" multiple data-testid="cosmetic-mods-input" />
				<div class="dropzone__status" data-testid="cosmetic-mods-status">
					@if (cosmeticFiles is null || cosmeticFiles.Count == 0)
					{
						<div>Loaded Mods: none</div>
					}
					else
					{
						<div>Loaded Mods:</div>
						<ul>
							@foreach (var file in cosmeticFiles)
							{
								<li>@file.Name (@FormatFileSize(file.Size))</li>
							}
						</ul>
					}
				</div>
			</div>
		</div>
	</div>

	<div class="landing__cta">
		<button class="btn btn-primary" type="button" disabled="@(!IsBaseModLoaded)" @onclick="GoToPlanner" data-testid="continue-button">Continue →</button>
		<span class="landing__cta-note">Enabled after base mod is loaded</span>
	</div>
</section>

@code {
	private IBrowserFile? baseModFile;
	private IReadOnlyList<IBrowserFile>? cosmeticFiles;

	private bool IsBaseModLoaded => baseModFile is not null;

	private void HandleBaseModSelected(InputFileChangeEventArgs args)
	{
		baseModFile = args.File;
	}

	private void HandleCosmeticModsSelected(InputFileChangeEventArgs args)
	{
		cosmeticFiles = args.GetMultipleFiles();
	}

	private static string FormatFileSize(long bytes)
	{
		const decimal kilo = 1024m;
		const decimal mega = 1024m * 1024m;

		if (bytes >= mega)
		{
			return $"{bytes / mega:0.##} MB";
		}

		return $"{bytes / kilo:0.##} KB";
	}

	private void GoToPlanner()
	{
		if (!IsBaseModLoaded)
		{
			return;
		}

		Navigation.NavigateTo("/planner", forceLoad: true);
	}

}
